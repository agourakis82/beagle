# Cert-Manager Setup for TLS/SSL with Let's Encrypt
# Handles automatic certificate provisioning and renewal for agourakis.com

---
# Namespace for cert-manager
apiVersion: v1
kind: Namespace
metadata:
  name: cert-manager
  labels:
    name: cert-manager

---
# CRDs and cert-manager installation (via Helm in practice)
# helm repo add jetstack https://charts.jetstack.io
# helm repo update
# helm install cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace \
#   --set installCRDs=true --version v1.13.0

# Cluster Issuer for Let's Encrypt Production
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-production
spec:
  acme:
    # Let's Encrypt production server
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@agourakis.com
    privateKeySecretRef:
      name: letsencrypt-production-key
    solvers:
    # DNS-01 solver using Cloudflare
    - dns01:
        cloudflare:
          email: admin@agourakis.com
          apiTokenSecretRef:
            name: cloudflare-api-token
            key: api-token
      selector:
        dnsNames:
        - "agourakis.com"
        - "*.agourakis.com"
    # HTTP-01 fallback solver
    - http01:
        ingress:
          class: nginx
      selector:
        dnsZones:
        - "agourakis.com"

---
# Cluster Issuer for Let's Encrypt Staging (testing)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
spec:
  acme:
    # Let's Encrypt staging server (for testing)
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: admin@agourakis.com
    privateKeySecretRef:
      name: letsencrypt-staging-key
    solvers:
    - dns01:
        cloudflare:
          email: admin@agourakis.com
          apiTokenSecretRef:
            name: cloudflare-api-token
            key: api-token
    - http01:
        ingress:
          class: nginx

---
# Secret containing Cloudflare API token for DNS validation
apiVersion: v1
kind: Secret
metadata:
  name: cloudflare-api-token
  namespace: cert-manager
type: Opaque
stringData:
  api-token: "${CLOUDFLARE_API_TOKEN}"  # Replace with actual token

---
# Certificate for main domain and wildcard
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: agourakis-tls
  namespace: beagle
spec:
  secretName: agourakis-tls-secret
  issuerRef:
    name: letsencrypt-production
    kind: ClusterIssuer
  dnsNames:
  - agourakis.com
  - "*.agourakis.com"
  - www.agourakis.com
  - api.agourakis.com
  - ws.agourakis.com
  - tracing.agourakis.com
  - metrics.agourakis.com
  - dashboard.agourakis.com
  - health.agourakis.com
  - docs.agourakis.com
  - status.agourakis.com
  - dev.agourakis.com
  - staging.agourakis.com
  duration: 2160h  # 90 days
  renewBefore: 720h  # 30 days
  commonName: agourakis.com
  keystores:
    pkcs12:
      create: true
      secretRef:
        name: agourakis-tls-secret-pkcs12

---
# Ingress configuration using cert-manager
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: beagle-main-ingress
  namespace: beagle
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-production
    cert-manager.io/acme-challenge-type: dns01
    # NGINX security headers
    nginx.ingress.kubernetes.io/ssl-protocols: "TLSv1.2 TLSv1.3"
    nginx.ingress.kubernetes.io/ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
    nginx.ingress.kubernetes.io/ssl-prefer-server-ciphers: "true"
    nginx.ingress.kubernetes.io/hsts: "true"
    nginx.ingress.kubernetes.io/hsts-max-age: "31536000"
    nginx.ingress.kubernetes.io/hsts-include-subdomains: "true"
    nginx.ingress.kubernetes.io/hsts-preload: "true"
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Permissions-Policy: geolocation=(), microphone=(), camera=()";
      more_set_headers "Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:";
spec:
  tls:
  - hosts:
    - agourakis.com
    - "*.agourakis.com"
    secretName: agourakis-tls-secret
  rules:
  - host: agourakis.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: beagle-frontend
            port:
              number: 3000
  - host: www.agourakis.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: beagle-frontend
            port:
              number: 3000
  - host: api.agourakis.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: beagle-server
            port:
              number: 8080
  - host: ws.agourakis.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: beagle-websocket
            port:
              number: 8081
  - host: health.agourakis.com
    http:
      paths:
      - path: /health
        pathType: Prefix
        backend:
          service:
            name: beagle-server
            port:
              number: 8080

---
# Network Policy for cert-manager
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cert-manager-allow-dns
  namespace: cert-manager
spec:
  podSelector:
    matchLabels:
      app: cert-manager
  policyTypes:
  - Egress
  egress:
  # Allow DNS queries
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
  # Allow HTTPS to Let's Encrypt
  - to:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 443
  # Allow HTTP for challenge validation
  - to:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 80

---
# ServiceMonitor for cert-manager metrics (Prometheus)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: cert-manager
  namespace: cert-manager
spec:
  selector:
    matchLabels:
      app.kubernetes.io/instance: cert-manager
      app.kubernetes.io/name: cert-manager
  endpoints:
  - port: metrics
    interval: 30s

---
# PrometheusRule for cert-manager alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: cert-manager-alerts
  namespace: cert-manager
spec:
  groups:
  - name: cert-manager
    interval: 30s
    rules:
    # Alert when certificate is expiring soon
    - alert: CertificateExpiringSoon
      expr: certmanager_certificate_expiration_timestamp_seconds - time() < 7 * 24 * 3600
      for: 1h
      labels:
        severity: warning
      annotations:
        summary: "Certificate expiring soon: {{ $labels.name }}"
        description: "Certificate {{ $labels.name }} will expire in less than 7 days"

    # Alert when certificate is expiring very soon
    - alert: CertificateExpiringCritical
      expr: certmanager_certificate_expiration_timestamp_seconds - time() < 24 * 3600
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Certificate expiring critically soon: {{ $labels.name }}"
        description: "Certificate {{ $labels.name }} will expire in less than 24 hours"

    # Alert when certificate renewal fails
    - alert: CertificateRenewalFailure
      expr: increase(certmanager_certificate_renewal_errors_total[1h]) > 0
      for: 15m
      labels:
        severity: critical
      annotations:
        summary: "Certificate renewal failure: {{ $labels.name }}"
        description: "Certificate {{ $labels.name }} renewal failed"

---
# ClusterRole for cert-manager
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cert-manager-webhook
rules:
- apiGroups: ["cert-manager.io"]
  resources: ["certificaterequests", "issuers", "clusterissuers"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["create", "get", "list", "patch", "watch"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]

---
# ConfigMap for cert-manager configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: cert-manager-config
  namespace: cert-manager
data:
  # Shared configuration
  shared-config: |
    # Maximum number of concurrent API requests
    max-concurrent-api-requests: 10
    # Shared issuer HTTP timeout
    shared-issuer-http-timeout: 10s
    # Number of DNS ACME servers to wait for (sequential)
    dns01-recursive-nameserver-timeout: 10s
    # Default behavior - do not wait for DNS propagation
    dns01-wait-for-propagation: true

  # Webhook configuration
  webhook-config: |
    # Webhook port
    secure-port: 6443
    # Health check port
    health-probe-bind-address: "0.0.0.0:6060"
    # Metrics port
    metrics-bind-address: "0.0.0.0:9402"
